services:
  # The Brain: Our Python Application
  app:
    build: .
    container_name: torplex_torbox_plex_manager
    restart: unless-stopped
    volumes:
      - ./config:/config
      - ./data:/data
      # Mount the rclone share so the app can see the files
      - /mnt/torbox:/mnt/torbox:shared
      # Mount the media folder locally so it's visible in project dir
      - ./media:/mnt/media
    environment:
      - CONFIG_PATH=/config
      - DATA_PATH=/data
      - MOUNT_PATH=/mnt/torbox
      - SYMLINK_PATH=/mnt/media
      - PUID=1000
      - PGID=1000
    ports:
      - "8000:8000"
    depends_on:
      - rclone
    profiles: ["core", "plex"]

  # Rclone: Mounts Torbox WebDAV
  rclone:
    image: rclone/rclone:latest
    container_name: torplex_rclone
    restart: unless-stopped
    privileged: true
    volumes:
      - ./config/rclone:/config/rclone
      - /mnt/torbox:/mnt/torbox:shared
    command: "mount torbox: /mnt/torbox --allow-other --dir-cache-time 10s --vfs-cache-mode full --allow-non-empty"
    profiles: ["core", "plex"]

  # Prowlarr: Indexer Manager
  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: torplex_prowlarr
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Etc/UTC
    volumes:
      - ./config/prowlarr:/config
    ports:
      - "9696:9696"
    restart: unless-stopped
    profiles: ["core", "plex"]

  # Flaresolverr: Often needed for Prowlarr to bypass Cloudflare
  flaresolverr:
    image: ghcr.io/flaresolverr/flaresolverr:latest
    container_name: torplex_flaresolverr
    environment:
      - LOG_LEVEL=info
    ports:
      - "8191:8191"
    restart: unless-stopped
    profiles: ["core", "plex"]

  # Plex Media Server (Optional)
  plex:
    image: lscr.io/linuxserver/plex:latest
    container_name: torplex_plex
    network_mode: host
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Etc/UTC
      - VERSION=docker
      - PLEX_CLAIM=${PLEX_CLAIM}
    volumes:
      - ./plex/config:/config
      - ./plex/transcode:/transcode
      - ./media:/data/media
      # Required for Plex to follow symlinks to Torbox mount
      - /mnt/torbox:/mnt/torbox:ro,rslave
    restart: unless-stopped
    profiles: ["plex"]
    # devices:
    #   - /dev/dri:/dev/dri # Intel QuickSync
    #   - /dev/nvidia0:/dev/nvidia0 # Nvidia (requires nvidia-container-toolkit)
